#! /bin/ksh -l
set -e 

export FUNCTION_PATH=/pf/a/a270073/esm-master/esm-runscripts/functions/all
export FPATH=${FUNCTION_PATH}:$FPATH

machine_name="mistral"   		
setup_name="awicm"		
#check=1

ACCOUNT=ab0246
compute_time="03:00:00"
post_time="01:00:00"

###############################################################################
#Xsrun  I know what I am doing

INITIAL_DATE_awicm=1850-01-01       # Initial exp. date
FINAL_DATE_awicm=2014-12-31         # Final date of the experiment
BASE_DIR=/work/ab0246/a270073/awicm-test/CMIP6/CMIP_PMIP/dynveg_true

## model options
# awicm
awicm_VERSION="test"
MODEL_DIR_awicm=/pf/a/a270073/esm-master/awicm-test/
POST_PROCESSING_awicm=1
POOL_DIR_awicm=/pool/data/
NMONTH_awicm=0          # default=0
NYEAR_awicm=1           # Number of years per run
CMIP6_namelists=1
LRESUME_awicm=1

# echam
echam_VERSION=echam-6.3.04p1
BIN_DIR_echam=${MODEL_DIR_awicm}/bin
RES_ECHAM=T63
SCENARIO_echam="HIST"
LRESUME_echam=1
# these restart files are the last files of the PI-CTRL run saved in 
# /work/ab0246/a270073/awicm-CMIP6/PI-CTRL4
# with changed filenames and vdate tags, see esm-usermanual restart examples in section 4.11
INI_PARENT_EXP_ID_echam=PI-CTRL4
INI_RESTART_DIR_echam=/work/ab0246/a270073/awicm-CMIP6/PI-CTRL4_dynveg_true_last_restarts/restart/echam
INI_PARENT_DATE_echam='18491231'
POOL_DIR_echam=/pool/data/
DISTURBED_YEARS_echam='1894'
DISTURBANCE_echam=1.00001
RESTART_FIRSTLAST_echam="'last'"

# jsbach
LCTLIBDEF_jsbach=${MODEL_DIR_awicm}/${echam_VERSION}/lctlib_nlct21.def
#jsbach_DATASET=r0007 # for cover_fract files WITH dynveg
jsbach_DATASET=r0010 # not r0009 for finding /pool/data/JSBACH/input/r0009/T63/land_use_maps/cover_fract_T63_11tiles_1850.nc
LRESUME_jsbach=1
INI_RESTART_DIR_jsbach=/work/ab0246/a270073/awicm-CMIP6/PI-CTRL4_dynveg_true_last_restarts/restart/jsbach
INI_PARENT_DATE_jsbach='18491231'
DYNVEG_jsbach="dynveg"
jsbach_ctl___use_dynveg___nml_entry=".true."
jsbach_ctl___use_dynveg___nml_file="namelist.jsbach"

# hdmodel
LRESUME_hdmodel=1
INI_RESTART_DIR_hdmodel=/work/ab0246/a270073/awicm-CMIP6/PI-CTRL4_dynveg_true_last_restarts/restart/hdmodel
INI_PARENT_DATE_hdmodel='18491231'

# fesom
BIN_DIR_fesom=${MODEL_DIR_awicm}/bin
RES_fesom=CORE2
#MESH_DIR_fesom=/pool/data/AWICM/FESOM1/MESHES/core/
MESH_DIR_fesom=/work/ab0995/a270046/meshes_default/core/
POOL_DIR_fesom=/work/ab0995/a270046/iceberg-input/ # for namelist paths climate data and forcing paths
LRESUME_fesom=1
INI_PARENT_EXP_ID_fesom=PI-CTRL4
INI_RESTART_DIR_fesom=/work/ab0246/a270073/awicm-CMIP6/PI-CTRL4_dynveg_true_last_restarts/restart/fesom
INI_PARENT_DATE_fesom='18491231'

# oasis3mct
CF_NAME_TABLE_oasis3mct=${MODEL_DIR_awicm}/oasis/cf_name_table.txt
LRESUME_oasis3mct=1
INI_RESTART_DIR_oasis3mct=/work/ab0246/a270073/awicm-CMIP6/PI-CTRL4_dynveg_true_last_restarts/restart/oasis3mct
INI_PARENT_DATE_oasis3mct='18491231'

## model output
# echam outdata
# see namelist.echam_CMIP6 generated by mkexp

# fesom outdata
# copied from tidos runscript:
#   /pf/a/a270062/esm-runscripts/runscripts/awicm/awicm.run.mistral_cmip6_hist1
#   tso: "sea surface temperature of liquid ocean, sampled synoptically"
#   tos: "sea surface temperature of liquid ocean"
# which generated this outout:
#   /work/bk0988/awicm/a270062/AWICM/hist1/outdata/fesom
# and adapted for PMIP,CMIP DECK simulation requests

# YAML info
# =========
# there is no "hourly" yaml_rate in the current yaml list
# workaround: yaml_unit = "s" --> model time step
# see fesoms namelist.config for model time step:
# --> step_per_day = 48 (core mesh)
# --> dt_model = 86400 s / 48 = 1800 s = 30 min
# if, e.g., yaml_unit = "s" && yaml_rate = 24 --> 30 min * 24 = output every 720 min = 12 hours
# --> dt_out [h] = 86400 * yaml_rate / 60 / 60 / step_per_day
# --> if, e.g., 3 hourly output is needed, then  
# <=> yaml_rate = dt_out [h] * step_per_day * 60 * 60 / 86400
#               =      3 [h] *           48 * 60 * 60 / 86400 = 6
fesom_yaml_number_varlist=4

fesom_yaml_varlist_1="tso" # in fesom, tso is snapshot of SST which is tos; dont get confused
fesom_yaml_unit_1="s"
fesom_yaml_rate_1=6
fesom_yaml_first_1=6

fesom_yaml_varlist_2="tossq,mlotst,mlotstsq,omldamax,sic,sithick,sitimefrac,siarean,siareas,siextentn,siextents,sivoln,sivols,siu,siv,so,sos,tauuo,tauvo,thetao,tos,zos,flice,wnet,evap,runoff,thdgr,thdgrsn"
fesom_yaml_unit_2="d"
fesom_yaml_rate_2=1
fesom_yaml_first_2=1

fesom_yaml_varlist_3="sossq,evs,fsitherm,hfds,tob,sob,opottemptend,pbo,pso,obvfsq,prlq,prsn,rsdo,sidmassevapsubl,sidmasssi,sidmassth,sidmasstranx,sidmasstrany,sifllatstop,sisnconc,sisnmass,sisnthick,sispeed,sivol,sistrxdtop,sistrxubot,sistrydtop,sistryubot,tosga,sosga,thetaoga,soga,u2o,uo,uso,uto,v2o,vo,volo,vso,vto,w2o,wfo,wo,wso,wto,zossq,rho,uhice,uhsnow,urho,uv,vhice,vhsnow,virtual_salt,vrho,lwrd,olat,olwout,osen,relax_salt,shum,tair,uwind,vwind"
fesom_yaml_unit_3="m"
fesom_yaml_rate_3=1
fesom_yaml_first_3=1

fesom_yaml_varlist_4="opottempmint,somint"
fesom_yaml_unit_4="y"
fesom_yaml_rate_4=1
fesom_yaml_first_4=1

# fesom restarts
RESTART_RATE_fesom=1
RESTART_FIRST_fesom=12
RESTART_fesom=12
RESTART_UNIT_fesom='m'

###############################################################################
load_all_functions
general_do_it_all $@
